◤◢◤◢◤◢◤◢◤◢◤◢◤◢  
✅ 成功：  
**スプレッドシートの構造と機能**について、現状のコードベースに基づき、詳細なレポートを作成します。

---

# スプレッドシート構造・機能詳細レポート

## 1. シート構造

### 1.1 シートの種類

- **管理シート（「管理」）**
  - 従業員名・商品名のマスタ管理用
  - A列：従業員名リスト（1行目はヘッダー）
  - B列：商品名リスト（1行目はヘッダー）

- **個人シート（`{従業員名}_{YYYY}年{MM}月`）**
  - 各従業員・各月ごとに1シート
  - 21日〜翌月20日で1シート（例：6/21〜7/20は「7月」シート）

---

### 1.2 個人シートのカラム構成

| 列 | 定数名         | 内容             | 例                  |
|----|---------------|------------------|---------------------|
| A  | -             | 日付             | 6/3, 2024-06-03     |
| C  | COL_PRODUCT   | 商品名           | お菓子A             |
| D  | COL_START     | 開始時刻         | 8:30                |
| E  | COL_END       | 終了時刻         | 17:15               |
| F  | COL_REST      | 休憩             | 0:45                |
| H  | COL_PACK_CNT  | 生産数           | 900                 |
| J  | COL_M_START   | 機械開始時刻     | 9:00                |
| K  | COL_M_END     | 機械終了時刻     | 17:00               |
| L  | COL_M_REST    | 機械休憩         | 0:30                |
| N  | COL_M_CNT     | 機械生産数       | 1200                |
| P  | COL_REMARK    | 備考             | 元区間: 8:30-12:00, 13:00-17:15 |

> ※B, G, I, M, O列は空欄または未使用

---

### 1.3 データ記録例

| A列   | C列     | D列   | E列   | F列  | H列  | J列  | K列  | L列  | N列  | P列                        |
|-------|---------|-------|-------|------|------|------|------|------|------|----------------------------|
| 6/3   | お菓子A | 8:30  | 17:15 | 0:45 | 900  | 9:00 | 17:00| 0:30 | 1200 | 元区間: 8:30-12:00, 13:00-17:15 |

---

## 2. 主な機能

### 2.1 マスタ情報の参照・補正

- **管理シート**から従業員名・商品名リストを取得
- OCR結果の氏名・商品名を正規化・曖昧一致で補正（`apply_autocorrect`）

### 2.2 データの記載・更新

- **個人シート**を従業員名・年月で特定
- A列（日付）から該当行を検索
- 既存行があれば上書き、新規なら追記
- 同一従業員・同一日の複数区間は自動で1行にマージ（開始時刻は最も早いもの、終了時刻は最も遅いもの、生産数は合計、備考欄に元区間情報）

### 2.3 休憩・生産数管理

- 休憩は「昼休み」「中休み」フラグで管理し、合計分数をF列/L列に記録
- 生産数は人手作業（H列）・機械作業（N列）で分離

### 2.4 重複・既存データの扱い

- 保存時、既存行があれば自動で上書き（ユーザーへの警告や確認は現状なし）
- `detect_any_duplicate`関数で重複検出も可能だが、現状はmain.pyから未使用

### 2.5 バッチ一括書き込み

- Google Sheets APIの`values_batch_update`で複数セルを一度に更新し、APIコストを最適化

---

## 3. データフロー

1. ユーザーが画像をアップロード
2. OCR処理（OpenAI API）→ 結果をJSONで取得
3. 管理シートのマスタ情報で氏名・商品名を補正
4. ユーザーが確認・修正
5. 修正済みデータを保存リクエスト
6. 個人シートの該当行にデータを記載（既存行は上書き、新規なら追記）

---

## 4. 補足・設計上の注意

- シートが存在しない場合はエラー（自動生成はしない）
- 日付の形式は多様に対応（6/3, 2024-06-03, 6月3日, 2024年6月3日 など）
- 休憩・生産数・備考など、業務運用に即した柔軟な設計
- 重複警告や上書き確認が必要な場合は追加実装が必要

---

## 5. 今後の拡張ポイント（例）

- 重複データ検出・警告のフロント返却
- 個人シートの自動生成
- 履歴管理・変更ログの記録
- マスタ情報の管理UI追加

---

**以上が現状のスプレッドシート構造と機能の詳細レポートです。  
追加の要件や運用ルールがあればご指示ください。**

◤◢◤◢◤◢◤◢◤ ◢◤◢◤◢